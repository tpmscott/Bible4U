<!doctype html>
<script src="idb.min.js"></script>

<button onclick="addBook()">Add a book</button>
<button onclick="clearBooks()">Clear books</button>
<button onclick="list_Ge()">1,21,1 Color</button>
<button onclick="Del_Ex()">Delete 2,3,3</button>
<button onclick="list()">List All</button>
<button onclick="list_c21()">List chap_no: 21</button>
<button onclick="list2()">List All from keyval</button>
<button onclick="list_by_Indx_chap_no()">List by Index chap</button>


<p>Books list:</p>

<ul id="listElem"></ul>

<script>

async function list_by_Indx_chap_no() {  // not working
  let tx = db.transaction('books');
  let bookStore = tx.objectStore('books');
  var myIndex = bookStore.index('chap_no');

  var book_c21_tmp=[] ;  // new array

  myIndex.openCursor().onsuccess = function(event) {

     var cursor = event.target.result;
     if(cursor) {
        if(cursor.value.chap_no == '21') {
           var tmp_name = cursor.value.name;
           book_c21_tmp.push( tmp_name );
        }
     }

  }

  txt = "name: <br>";
  book_c21_tmp.forEach(myFunction_c21);
  //books_All.forEach(myFunction_c21);
  document.getElementById("listElem").innerHTML = txt;  

}


let db;
let db2;

init();

async function init() {
  db = await idb.openDb('booksDb', 1, db => {
    db.createObjectStore('books', {keyPath: 'name'});   // mean : name is primary key
    ObjectStore.createIndex('color_no', 'color_no', { unique: false });
    ObjectStore.createIndex('book_no', 'book_no', { unique: false });
    ObjectStore.createIndex('chap_no', 'chap_no', { unique: false });
    ObjectStore.createIndex('vers_no', 'vers_no', { unique: false });
  });
  db2 = await idb.openDb('keyval-store', 1, db => {
    db.createObjectStore('keyval', {keyPath: 'key'});   // mean : name is primary key
    //ObjectStore.createIndex('book_no', 'book_no', { unique: false });
    //ObjectStore.createIndex('chap_no', 'chap_no', { unique: false });
  });

  list();
  //list2();  // for db2

}

async function list() {
  let tx = db.transaction('books');
  let bookStore = tx.objectStore('books');

  //let books = await bookStore.getAll();

  let books_All = await bookStore.getAll();

  if (books_All.length) {
    listElem.innerHTML = books_All.map(book => `<li>
        name: ${book.name}, color: ${book.color_no}, book_no: ${book.book_no}, chap_no: ${book.chap_no}, vers_no: ${book.vers_no}
      </li>`).join('');
  } else {
    listElem.innerHTML = '<li>No books yet. Please add books.</li>'
  }

}


async function list2() {   // for db2  -- not working
  let tx2 = db2.transaction('keyval');
  let keyvalStore = tx2.objectStore('keyval');

  //let books = await bookStore.getAll();

  let keyval_All = await keyvalStore.getAll();

  if (keyval_All.length) {
    listElem.innerHTML = keyval_All.map(book => `<li>
        key: ${book.key}, value: ${book.value}
      </li>`).join('');
  } else {
    listElem.innerHTML = '<li>No books yet. Please add books.</li>'
  }

}


//  var numbers = [65, 44, 12, 4];
//  var newarray = numbers.map(myFunction)

//  function myFunction(num) {
//    return num * 10;
//  }

//  document.getElementById("demo").innerHTML = newarray;

//function prepare_c21()

var txt = "";

async function list_c21() {  // chap = 21
  let tx = db.transaction('books');
  let bookStore = tx.objectStore('books');

  //let books = await bookStore.getAll();

  let books_All = await bookStore.getAll(); // 

  var book_c21=[] ;  // new array

   for (i = 0; i < books_All.length; i++) {

      var tmp_name = books_All[i].name;
      var tmp_chap_no = books_All[i].chap_no;

      if( tmp_chap_no == "21" ) {
      //if( i == 1 ) {

         //book_c21.unshift( tmp_name );
         book_c21.push( tmp_name );

      }

   }

  //book_c21.push( '1,21,1' );
  //book_c21.push( '1,21,4' );

  //book_c21[0]='1,21,1';

  txt = "name: <br>";
  book_c21.forEach(myFunction_c21);
  //books_All.forEach(myFunction_c21);
  document.getElementById("listElem").innerHTML = txt;



}

function myFunction_c21(value, index, array) {
  txt = txt + value + "<br>"; 
}


async function list_Ge() {
  let tx = db.transaction('books');
  let bookStore = tx.objectStore('books');

  //let books = await bookStore.getAll();

  let books_Ge = await bookStore.get('1_21_1');  // get() using primary key as parameter

  //listElem.innerHTML = books_Ge.color;

  if (books_Ge) {

     listElem.innerHTML = books_Ge.color_no;

  }
  else {

     listElem.innerHTML = 'No Data';

  }


  //if (books_Ge.length) {
  //  listElem.innerHTML = books_Ge.map(book => `<li>
  //      name: ${book.name}, price: ${book.price}
  //    </li>`).join('');
  //} else {
  //  listElem.innerHTML = '<li>No books yet. Please add books.</li>'
  //}

}


async function list_Indx_book_no() {  // Not working
  let tx = db.transaction('books');
  let bookStore = tx.objectStore('books');
  let index = bookStore.index('chap_no');

  var books_In = await index.get('22');

  //let books = await bookStore.getAll();

  //let books_Ge = await bookStore.get('1,21,1');  // get() using primary key as parameter

  listElem.innerHTML = books_In.name;

  //if (books_Ge.length) {
  //  listElem.innerHTML = books_Ge.map(book => `<li>
  //      name: ${book.name}, price: ${book.price}
  //    </li>`).join('');
  //} else {
  //  listElem.innerHTML = '<li>No books yet. Please add books.</li>'
  //}

}



async function Del_Ex() {
  //let tx = db.transaction('books');
  //let bookStore = tx.objectStore('books');

  //let books = await bookStore.getAll();

  //await bookStore.delete('Ex');  // delete() using primary key as parameter


  let tx = db.transaction('books', 'readwrite');
  await tx.objectStore('books').delete('2,3,3');
  await list();


  //listElem.innerHTML = books_Ge.price;

  //if (books_Ge.length) {
  //  listElem.innerHTML = books_Ge.map(book => `<li>
  //      name: ${book.name}, price: ${book.price}
  //    </li>`).join('');
  //} else {
  //  listElem.innerHTML = '<li>No books yet. Please add books.</li>'
  //}

}


async function clearBooks() {
  let tx = db.transaction('books', 'readwrite');
  await tx.objectStore('books').clear();
  await list();
}

async function addBook() {
  let name = prompt("Book name?");
  let color = +prompt("Book color?");
  let book_no = +prompt("Book No?");
  let chap_no = +prompt("Chap No?");
  let vers_no = +prompt("Vers No?");

  let tx = db.transaction('books', 'readwrite');

  try {
    await tx.objectStore('books').add({name, color, book_no, chap_no, vers_no});
    await list();
  } catch(err) {
    if (err.name == 'ConstraintError') {
      alert("Such book exists already");
      await addBook();
    } else {
      throw err;
    }
  }
}

window.addEventListener('unhandledrejection', event => {
  alert("Error: " + event.reason.message);
});

</script>